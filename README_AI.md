# 🤖 AI統合ガイド - Claude API設定方法

## 概要

AI機能を有効にすると、以下の高度な分析が可能になります：

1. **専攻と職種の関連性判定** - AIが専攻と職種の適合性を0-100点でスコアリング
2. **業務内容の専門性分析** - 単純労働でないかをAIが詳細に分析
3. **改善提案の自動生成** - 不足要件を満たすための具体的なアドバイス

---

## 📝 Claude APIキーの取得方法

### Step 1: Anthropicアカウントの作成

1. https://console.anthropic.com/ にアクセス
2. 「Sign Up」をクリック
3. メールアドレスとパスワードを入力して登録

### Step 2: APIキーの作成

1. ログイン後、左メニューの「API Keys」をクリック
2. 「Create Key」ボタンをクリック
3. キー名を入力（例: `visa_system`）
4. 「Create Key」をクリック
5. **表示されたAPIキーをコピー**（`sk-ant-...`で始まる文字列）

⚠️ **重要:** APIキーは一度しか表示されません。必ずコピーして安全に保管してください。

### Step 3: クレジットの追加

1. 左メニューの「Billing」をクリック
2. 「Add Credits」をクリック
3. 最小金額（$5-10程度）を追加

💡 **コスト目安:**
- 1診断あたり: 約$0.01-0.03（1-3円）
- 月100件診断: 約$1-3（100-300円）
- 月1000件診断: 約$10-30（1,000-3,000円）

---

## ⚙️ システムへの設定

### 方法1: settings.pyを直接編集

`visa_system/settings.py`を開いて、以下の部分を編集：

```python
# AI統合設定
# Claude APIキーを設定してください
ANTHROPIC_API_KEY = 'sk-ant-ここにあなたのAPIキーを貼り付け'  # ← ここを変更

# AI機能の有効化フラグ
ENABLE_AI_FEATURES = True  # ← Falseをtrueに変更
```

### 方法2: 環境変数を使用（推奨・本番環境用）

Windowsの場合:
```cmd
set ANTHROPIC_API_KEY=sk-ant-your-key-here
```

Mac/Linuxの場合:
```bash
export ANTHROPIC_API_KEY=sk-ant-your-key-here
```

そして`settings.py`を以下のように変更:
```python
import os

ANTHROPIC_API_KEY = os.environ.get('ANTHROPIC_API_KEY', None)
ENABLE_AI_FEATURES = bool(ANTHROPIC_API_KEY)
```

---

## 🧪 動作テスト

### テスト1: AIモジュール単体テスト

```cmd
cd visa_diagnosis
python ai_integration.py sk-ant-your-key-here
```

成功すると:
```
✅ AI機能が利用可能です

【テスト1】専攻と職種の関連性分析
スコア: 95点
レベル: 高い
理由: 情報工学の知識がシステム開発に直接活用できます

【テスト2】業務内容の分析
適合: True
専門性スコア: 92点
強み: 専門的な技術知識が必要, 企画・設計業務を含む

✅ テスト完了
```

### テスト2: システム全体のテスト

1. サーバーを起動
```cmd
python manage.py runserver
```

2. 起動時のログを確認
```
✅ AI機能が有効化されました  ← これが表示されればOK
```

3. 診断フォームで実際に診断を実行
4. 診断結果ページに「🤖 AI詳細分析」セクションが表示される

---

## 📊 AI分析の表示例

診断結果ページに以下のような分析が追加されます：

```
🤖 AI詳細分析

📚 専攻と職種の関連性
85点 - 関連あり
分析: 情報工学の知識がシステム開発業務に直接活かせます。
      プログラミングやアルゴリズムの理解が必須です。
💡 アドバイス: 学歴と職務の関連性が高く、技術・人文知識・
              国際業務での申請が適しています。

💼 業務内容の分析
専門性スコア: 88点

✅ 強み:
  • 要件定義や設計など企画業務を含む
  • 大学レベルの専門知識が必要
  • 判断を伴う知的業務

⚠️ 懸念点:
  • なし

💡 改善提案:
  • 現状の業務内容で申請可能です

🎯 総合改善提案
・現在の学歴・経験・業務内容で十分申請可能です
・業務内容の記載をより詳細にすると審査が円滑になります
・システムの規模や使用技術を具体的に記載することを推奨します
```

---

## 🔧 トラブルシューティング

### エラー: `ModuleNotFoundError: No module named 'anthropic'`

**解決方法:**
```cmd
pip install anthropic
```

### エラー: `AuthenticationError: Invalid API key`

**原因:** APIキーが正しくない

**確認事項:**
1. APIキーが`sk-ant-`で始まっているか
2. コピー時に余分なスペースが入っていないか
3. シングルクォート`'`で囲んでいるか

### AI機能が有効にならない

**確認事項:**
```python
# settings.pyで以下を確認
print(f"API Key設定: {ANTHROPIC_API_KEY is not None}")
print(f"AI機能: {ENABLE_AI_FEATURES}")
```

両方が`True`になっているか確認

### レスポンスが遅い

**対策:**
- AIの分析には3-5秒かかります（正常）
- 必要に応じてタイムアウト設定を追加可能
- キャッシング機能の実装も検討可能

---

## 💰 コスト管理

### 使用量の確認

1. https://console.anthropic.com/ にログイン
2. 「Usage」をクリック
3. 日別・月別の使用量を確認

### 予算アラートの設定

1. 「Billing」→「Budget Alerts」
2. 上限金額を設定（例: $10/月）
3. メール通知を有効化

### コスト削減のヒント

1. **開発中はAI機能をOFF**
   ```python
   ENABLE_AI_FEATURES = False  # 開発時
   ```

2. **結果のキャッシング**（将来実装）
   - 同じ専攻×職種の組み合わせは再利用
   - データベースに保存

3. **条件分岐**
   - 明確なケースはルールベースで判定
   - 微妙なケースのみAIを使用

---

## 🚀 次のステップ

AI機能が動作したら：

1. **様々なパターンでテスト**
   - 専攻と職種の組み合わせ
   - 業務内容の記載方法

2. **精度の検証**
   - 過去の実案件でテスト
   - 専門家の判断と比較

3. **プロンプトの最適化**
   - より正確な判定のための調整
   - 業界特有の知識を追加

4. **機能の拡張**
   - 診断履歴の分析
   - 統計データの活用
   - レポート生成機能

---

## 📞 サポート

問題が解決しない場合:
1. エラーメッセージをコピー
2. 以下の情報を確認:
   - Pythonバージョン
   - anthropicパッケージのバージョン
   - settings.pyの設定内容

---

**AI機能で診断の精度が劇的に向上します！**
